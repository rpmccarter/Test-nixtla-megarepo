name: Update

on:
  workflow_dispatch:
  repository_dispatch:
    types: [update]

concurrency:
  group: update
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PUSH_TOKEN }}
      - name: Clean repo
        run: rm -rf statsforecast mlforecast neuralforecast hierarchicalforecast

      - name: Clone nixtla
        uses: actions/checkout@v3
        with:
          path: nixtla
          repository: 'Nixtla/nixtla'
          ref: 'docs'
      - name: Clone statsforecast
        uses: actions/checkout@v3
        with:
          path: statsforecast
          repository: 'Nixtla/statsforecast'
          ref: 'docs'
      - name: Clone mlforecast
        uses: actions/checkout@v3
        with:
          path: mlforecast
          repository: 'Nixtla/mlforecast'
          ref: 'docs'
      - name: Clone neuralforecast
        uses: actions/checkout@v3
        with:
          path: neuralforecast
          repository: 'Nixtla/neuralforecast'
          ref: 'docs'
      - name: Clone hierarchicalforecast
        uses: actions/checkout@v3
        with:
          path: hierarchicalforecast
          repository: 'Nixtla/hierarchicalforecast'
          ref: 'docs'
      - name: Clone utilsforecast
        uses: actions/checkout@v3
        with:
          path: utilsforecast
          repository: 'Nixtla/utilsforecast'
          ref: 'docs'
      - name: Clone datasetsforecast
        uses: actions/checkout@v3
        with:
          path: datasetsforecast
          repository: 'Nixtla/datasetsforecast'
          ref: 'docs'
      - name: Clone coreforecast
        uses: actions/checkout@v3
        with:
          path: coreforecast
          repository: 'Nixtla/coreforecast'
          ref: 'docs'
      - name: Remove .git folders
        run: rm -rf */.git

      - name: Compile mint.json
        run: |
          jq -s '{
            config: .[0],
            navigations: [
              {
                name: "nixtla",
                config: .[1]
              },
              {
                name: "statsforecast",
                config: .[2]
              },
              {
                name: "mlforecast",
                config: .[3]
              },
              {
                name: "neuralforecast",
                config: .[4]
              },
              {
                name: "hierarchicalforecast",
                config: .[5]
              },
              {
                name: "utilsforecast",
                config: .[6]
              },
              {
                name: "datasetsforecast",
                config: .[7]
              },
              {
                name: "coreforecast",
                config: .[8]
              }
            ]
          }
          | .navigations |= map(
            .name as $prefix 
            | .config.navigation |= walk(
              if type == "array" 
                then map(
                  if type == "string"
                    then $prefix + "/" + .
                    else .
                  end
                )
                else . 
              end
            )
          )
          | .config.navigation = (
            [.navigations[].config.navigation]
            | add
          ) 
          | .config' mint.json nixtla/mint.json statsforecast/mint.json mlforecast/mint.json neuralforecast/mint.json hierarchicalforecast/mint.json utilsforecast/mint.json datasetsforecast/mint.json coreforecast/mint.json > mint-temp.json
          mv mint-temp.json mint.json

      # only runs when changed files are detected
      - name: Push changes
        run: |
          git config user.name "Mintie Bot"
          git config user.email "aws@mintlify.com"
          git add .
          if git diff-index --quiet --cached HEAD -- ; then
            echo 'No changes detected, skipping...'
          else
            git commit -m "update"
            git push origin main
          fi
